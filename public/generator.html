<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QSL Card Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-color: #1a1a2e;
      --card-bg: #16213e;
      --accent: #e94560;
      --text: #eee;
      --text-muted: #aaa;
    }

    body {
      background: var(--bg-color);
      color: var(--text);
      min-height: 100vh;
    }

    .card-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    #qslCanvas {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }

    .form-control, .form-select {
      background: #0f0f23;
      border: 1px solid #333;
      color: var(--text);
    }

    .form-control:focus, .form-select:focus {
      background: #0f0f23;
      border-color: var(--accent);
      color: var(--text);
      box-shadow: 0 0 0 0.2rem rgba(233, 69, 96, 0.25);
    }

    .form-control::placeholder {
      color: var(--text-muted);
    }

    .form-label {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .btn-primary {
      background: var(--accent);
      border: none;
      padding: 12px 30px;
      font-weight: 600;
    }

    .btn-primary:hover {
      background: #c73e54;
    }

    .caps {
      text-transform: uppercase;
    }

    .header-info {
      text-align: center;
      margin-bottom: 20px;
    }

    .header-info h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    .header-info a {
      color: var(--accent);
      text-decoration: none;
    }

    .loading {
      text-align: center;
      padding: 50px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #333;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .auth-container {
      max-width: 400px;
      margin: 100px auto;
    }

    .user-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
    }

    .user-bar .user-info {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .access-denied {
      text-align: center;
      padding: 50px;
    }

    .access-denied h2 {
      color: var(--accent);
    }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      .card-container { padding: 15px; }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="loading-spinner mx-auto mb-3"></div>
      <p>Loading...</p>
    </div>

    <!-- Login Section -->
    <div id="authSection" class="auth-container" style="display: none;">
      <div class="card-container">
        <h3 class="mb-4">Login Required</h3>
        <p class="text-muted mb-4">Please login to access the QSL Card Generator.</p>
        <div class="mb-3">
          <label class="form-label">Username</label>
          <input type="text" class="form-control" id="loginUsername" placeholder="Enter username">
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="loginPassword" placeholder="Enter password">
        </div>
        <button class="btn btn-primary w-100" onclick="login()">Login</button>
        <div id="authError" class="text-danger mt-2" style="display:none;"></div>
        <div class="text-center mt-3">
          <a href="/" class="text-muted">Back to Home</a>
        </div>
      </div>
    </div>

    <!-- Access Denied Section -->
    <div id="accessDenied" class="access-denied" style="display: none;">
      <div class="card-container">
        <h2>Access Denied</h2>
        <p class="text-muted">You can only generate QSL cards for your own callsign.</p>
        <p id="deniedMessage"></p>
        <a href="/" class="btn btn-primary mt-3">Back to Home</a>
        <button class="btn btn-outline-secondary mt-3 ms-2" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Generator Content -->
    <div id="content" style="display: none;">
      <div class="user-bar">
        <span class="user-info">Logged in as: <strong id="currentUser"></strong></span>
        <button class="btn btn-outline-secondary btn-sm" onclick="logout()">Logout</button>
      </div>

      <div class="header-info mb-4">
        <h1 id="stationName">QSL Card Generator</h1>
        <a id="qrzLink" href="#" target="_blank"></a>
      </div>

      <div class="row g-4">
        <div class="col-lg-7">
          <div class="card-container">
            <canvas id="qslCanvas"></canvas>
          </div>
          <div class="text-center mt-3">
            <button id="downloadBtn" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
              </svg>
              QSL Karte speichern
            </button>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="card-container">
            <form id="qslForm">
              <div class="mb-3">
                <label for="callsign" class="form-label">Rufzeichen der Gegenstation</label>
                <input type="text" class="form-control caps" id="callsign" placeholder="z.B. DL5XYZ">
              </div>

              <div class="mb-3">
                <label for="utcDateTime" class="form-label">UTC Datum/Uhrzeit (dd.mm.yyyy hh:mm)</label>
                <input type="text" class="form-control" id="utcDateTime" placeholder="dd.mm.yyyy hh:mm">
              </div>

              <div class="row g-2 mb-3">
                <div class="col-4">
                  <label for="frequency" class="form-label">Frequenz (MHz)</label>
                  <input type="text" class="form-control" id="frequency" placeholder="145.500">
                </div>
                <div class="col-4">
                  <label for="mode" class="form-label">Modus</label>
                  <input type="text" class="form-control caps" id="mode" placeholder="FM">
                </div>
                <div class="col-4">
                  <label for="rst" class="form-label">RST</label>
                  <input type="text" class="form-control" id="rst" placeholder="59">
                </div>
              </div>

              <div class="mb-3">
                <label for="additional" class="form-label">Zusätzliche Bemerkung</label>
                <textarea class="form-control" id="additional" rows="2" style="resize:none">Thanks for the QSO
Best regards</textarea>
              </div>

              <div class="mb-3">
                <label for="backgroundSelect" class="form-label">Hintergrund</label>
                <select class="form-select" id="backgroundSelect">
                  <option value="">-- Bitte wählen --</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="customBackground" class="form-label">Eigenes Bild hochladen</label>
                <input type="file" class="form-control" id="customBackground" accept="image/*">
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Get callsign from URL
    const pathParts = window.location.pathname.split('/').filter(Boolean);
    const CALLSIGN = pathParts[0] || '';

    let token = localStorage.getItem('authToken') || '';
    let currentUser = null;
    let config = null;
    let positions = null;
    const SCALE_FACTOR = 0.4;

    const canvas = document.getElementById('qslCanvas');
    const ctx = canvas.getContext('2d');
    const cardImage = new Image();
    const backgroundImage = new Image();

    // API call helper with auth
    async function apiCall(url, options = {}) {
      options.headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`
      };
      return fetch(url, options);
    }

    // Check authentication and access
    async function checkAccess() {
      if (!token) {
        showLogin();
        return;
      }

      try {
        // Verify token is still valid
        const meResponse = await apiCall('/api/auth/me');
        if (!meResponse.ok) {
          token = '';
          localStorage.removeItem('authToken');
          showLogin();
          return;
        }

        currentUser = await meResponse.json();

        // Check access to this callsign
        const accessResponse = await apiCall(`/api/generator/${CALLSIGN}/access`);
        if (!accessResponse.ok) {
          // Show generic not found for any error (prevents enumeration)
          window.location.href = '/';
          return;
        }

        config = await accessResponse.json();
        positions = config.textPositions;

        await loadGenerator();
      } catch (error) {
        console.error('Access check failed:', error);
        showLogin();
      }
    }

    function showLogin() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('content').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'none';
    }

    function showAccessDenied() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('content').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'block';
      document.getElementById('deniedMessage').textContent =
        `Your account (${currentUser.username}) is linked to callsign ${currentUser.callsign?.toUpperCase() || 'none'}, not ${CALLSIGN.toUpperCase()}.`;
    }

    async function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        showAuthError('Please enter username and password');
        return;
      }

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();
        if (response.ok) {
          token = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', token);
          checkAccess();
        } else {
          showAuthError(data.error || 'Login failed');
        }
      } catch (e) {
        showAuthError('Connection error');
      }
    }

    function logout() {
      apiCall('/api/auth/logout', { method: 'POST' }).catch(() => {});
      localStorage.removeItem('authToken');
      token = '';
      currentUser = null;
      window.location.href = '/';
    }

    function showAuthError(msg) {
      const el = document.getElementById('authError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    async function loadGenerator() {
      document.getElementById('currentUser').textContent = currentUser.username;
      document.getElementById('stationName').textContent = config.name;
      document.getElementById('qrzLink').href = config.qrzLink;
      document.getElementById('qrzLink').textContent = config.id.toUpperCase();
      document.title = `QSL Card - ${config.id.toUpperCase()}`;

      await loadBackgrounds();
      loadCardImage();

      document.getElementById('loading').style.display = 'none';
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('accessDenied').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    // Load backgrounds list (protected)
    async function loadBackgrounds() {
      try {
        const response = await apiCall(`/api/generator/${CALLSIGN}/backgrounds`);
        const backgrounds = await response.json();

        const select = document.getElementById('backgroundSelect');
        select.innerHTML = '<option value="">-- Bitte wählen --</option>';

        backgrounds.forEach(bg => {
          const option = document.createElement('option');
          option.value = bg.filename;
          option.textContent = bg.displayName;
          select.appendChild(option);
        });

        // Select first background if available
        if (backgrounds.length > 0) {
          select.value = backgrounds[0].filename;
          loadBackground(backgrounds[0].filename);
        }
      } catch (error) {
        console.error('Failed to load backgrounds:', error);
      }
    }

    // Load image with authentication
    async function loadAuthenticatedImage(img, url) {
      try {
        const response = await apiCall(url);
        if (!response.ok) throw new Error('Failed to load image');
        const blob = await response.blob();
        img.src = URL.createObjectURL(blob);
      } catch (error) {
        console.error('Failed to load image:', error);
      }
    }

    // Load card template image
    function loadCardImage() {
      cardImage.onload = () => {
        canvas.width = cardImage.width * SCALE_FACTOR;
        canvas.height = cardImage.height * SCALE_FACTOR;
        drawCanvas();
      };
      loadAuthenticatedImage(cardImage, `/api/cards/${CALLSIGN}/card.png`);
    }

    // Load background image
    function loadBackground(filename) {
      backgroundImage.onload = drawCanvas;
      loadAuthenticatedImage(backgroundImage, `/api/cards/${CALLSIGN}/backgrounds/${filename}`);
    }

    // Draw canvas with all layers
    function drawCanvas() {
      if (!cardImage.complete) return;

      // Draw background if loaded
      if (backgroundImage.complete && backgroundImage.src) {
        ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
      } else {
        ctx.fillStyle = '#333';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // Draw card template overlay
      ctx.drawImage(cardImage, 0, 0, canvas.width, canvas.height);

      // Get form values
      const callsign = document.getElementById('callsign').value.toUpperCase();
      const utcDateTime = document.getElementById('utcDateTime').value;
      const frequency = document.getElementById('frequency').value;
      const mode = document.getElementById('mode').value.toUpperCase();
      const rst = document.getElementById('rst').value;
      const additional = document.getElementById('additional').value.split('\n');

      // Format date/time
      let formattedDateTime = utcDateTime;
      if (utcDateTime) {
        try {
          const parts = utcDateTime.split(' ');
          const datePart = parts[0].split('.');
          const timePart = (parts[1] || '00:00').split(':');
          const d = new Date(datePart[2], datePart[1] - 1, datePart[0], timePart[0], timePart[1]);
          formattedDateTime = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        } catch (e) {}
      }

      // Draw text fields
      ctx.fillStyle = 'black';
      ctx.textBaseline = 'middle';

      // Callsign
      ctx.font = `${100 * SCALE_FACTOR}px Arial`;
      ctx.textAlign = 'center';
      ctx.fillText(callsign, positions.callsign.x * SCALE_FACTOR, positions.callsign.y * SCALE_FACTOR);

      // Date/Time
      ctx.font = `${80 * SCALE_FACTOR}px Arial`;
      ctx.fillText(formattedDateTime, positions.utcDateTime.x * SCALE_FACTOR, positions.utcDateTime.y * SCALE_FACTOR);

      // Frequency, Mode, RST
      ctx.font = `${100 * SCALE_FACTOR}px Arial`;
      ctx.fillText(frequency, positions.frequency.x * SCALE_FACTOR, positions.frequency.y * SCALE_FACTOR);
      ctx.fillText(mode, positions.mode.x * SCALE_FACTOR, positions.mode.y * SCALE_FACTOR);
      ctx.fillText(rst, positions.rst.x * SCALE_FACTOR, positions.rst.y * SCALE_FACTOR);

      // Additional remarks
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.font = `bold ${100 * SCALE_FACTOR}px Arial`;
      ctx.fillText(additional[0] || '', positions.additional.x * SCALE_FACTOR, positions.additional.y * SCALE_FACTOR);
      ctx.fillText(additional[1] || '', positions.additional.x * SCALE_FACTOR, positions.additional.y * SCALE_FACTOR + (120 * SCALE_FACTOR));
    }

    // Event listeners
    document.getElementById('backgroundSelect').addEventListener('change', function() {
      if (this.value) {
        loadBackground(this.value);
        // Remove custom option if exists
        const customOpt = this.querySelector('option[value="custom"]');
        if (customOpt) customOpt.remove();
      }
    });

    document.getElementById('customBackground').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          backgroundImage.src = ev.target.result;

          const select = document.getElementById('backgroundSelect');
          let customOpt = select.querySelector('option[value="custom"]');
          if (!customOpt) {
            customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.textContent = 'Eigenes Bild';
            select.appendChild(customOpt);
          }
          select.value = 'custom';
        };
        reader.readAsDataURL(file);
      }
    });

    // Form input listeners
    document.querySelectorAll('#qslForm input, #qslForm textarea').forEach(el => {
      el.addEventListener('input', drawCanvas);
    });

    // Download button with audit logging
    document.getElementById('downloadBtn').addEventListener('click', async function() {
      const callsignVal = document.getElementById('callsign').value || 'QSL';

      // Log the download
      try {
        await apiCall(`/api/generator/${CALLSIGN}/download`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetCallsign: callsignVal.toUpperCase() })
        });
      } catch (e) {
        console.error('Failed to log download:', e);
      }

      const link = document.createElement('a');
      link.download = `${callsignVal.toUpperCase()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // Set current UTC time
    function setCurrentUTC() {
      const now = new Date();
      const formatted = `${String(now.getUTCDate()).padStart(2, '0')}.${String(now.getUTCMonth() + 1).padStart(2, '0')}.${now.getUTCFullYear()} ${String(now.getUTCHours()).padStart(2, '0')}:${String(now.getUTCMinutes()).padStart(2, '0')}`;
      document.getElementById('utcDateTime').value = formatted;
    }

    // Allow Enter key to login
    document.getElementById('loginPassword').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') login();
    });

    // Initialize
    setCurrentUTC();
    checkAccess();
  </script>
</body>
</html>
